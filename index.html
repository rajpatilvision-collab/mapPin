<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Accounts Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 620px; }
    </style>
</head>

<body>
<div id="map"></div>

<script>
let map;

ZOHO.embeddedApp.on("PageLoad", function () {
    initMap();
    loadAccounts();
});

ZOHO.embeddedApp.init();

function initMap() {
    map = L.map("map").setView([20, 0], 2);
    
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);
}

function loadAccounts() {
    ZOHO.CRM.API.getAllRecords({
        Entity: "Accounts",
        per_page: 200
    }).then(function(response) {
        if (response && response.data) {
            let bounds = new L.LatLngBounds();
            
            response.data.forEach(function(account) {
                const lat = parseFloat(account.Latitude || account.LATITUDE);
                const lng = parseFloat(account.Longitude || account.LONGITUDE);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const name = account.Account_Name || "Unknown Account";
                    const city = account.City || "N/A";
                    const price = account.Price || "0";
                    
                    addMarker(lat, lng, name, city, price);
                    bounds.extend([lat, lng]);
                }
            });
            
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
    });
}

function addMarker(lat, lng, name, city, price) {
    const marker = L.circleMarker([lat, lng], {
        radius: 8,
        fillColor: "#3388ff",
        color: "#ffffff",
        weight: 2,
        fillOpacity: 1
    }).addTo(map);
    
    const popupContent = `
        <div style="min-width: 150px; padding: 5px;">
            <strong>${escapeHtml(name)}</strong><br>
            City: ${escapeHtml(city.toString())}<br>
            Price:${escapeHtml(price.toString())}
        </div>
    `;
    
    marker.bindPopup(popupContent);
    
    marker.on('mouseover', function() {
        this.openPopup();
    });
}

function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</body>
</html>
