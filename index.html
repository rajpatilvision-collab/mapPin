<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Accounts Map</title>
   
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>

    <style>
        body { margin: 0; }
        #map { width: 100%; height: 620px; }
        /* Styling for custom blue markers */
        .blue-marker {
            background-color: blue;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }
    </style>
</head>

<body>
<div id="map"></div>

<script>
let map;
let bounds;

ZOHO.embeddedApp.on("PageLoad", function () {
    initMap();
    loadAccounts();
});

ZOHO.embeddedApp.init();

function initMap() {
    map = L.map("map").setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    bounds = L.latLngBounds();
}

function loadAccounts() {
    let page = 1;
    const perPage = 200;

    function fetchPage() {
        ZOHO.CRM.API.getRecords({
            Entity: "Accounts",
            page: page,
            per_page: perPage,
            // Add specific fields to fetch
            fields: ["Account_Name", "Latitude", "Longitude", "Employees", "Number_of_Employees"]
        }).then(function (response) {
            console.log("API Response:", response);

            if (!response.data || response.data.length === 0) {
                console.log("No data returned");
                return;
            }

            response.data.forEach(function (rec) {
                console.log("Full Record:", rec);
                
                // Try different field names for latitude/longitude
                const lat = parseFloat(rec.Latitude || rec.LATITUDE || 0);
                const lng = parseFloat(rec.Longitude || rec.LONGITUDE || 0);
                
                console.log(`Lat: ${lat}, Lng: ${lng}`, rec);

                if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                    console.log("Skipping - Invalid coordinates");
                    return;
                }

                const name = rec.Account_Name || "No Name";
                
                // Try multiple possible field names for employees
                const employees = rec.Employees || 
                                 rec.Number_of_Employees || 
                                 rec.NUMBEROFEMPLOYEES || 
                                 "N/A";
                
                console.log(`Adding marker: ${name}, Employees: ${employees}`);
                
                addMarker(lat, lng, name, employees);
            });

            if (response.data.length === perPage) {
                page++;
                fetchPage();
            } else if (bounds.isValid() && bounds.getNorthEast()) {
                map.fitBounds(bounds, { padding: [40, 40] });
            } else {
                console.log("No valid bounds to fit");
            }
        }).catch(function (error) {
            console.error("API Error:", error);
        });
    }

    fetchPage();
}

function addMarker(lat, lng, name, employees) {
    // Create a custom blue icon
    const blueIcon = L.divIcon({
        className: 'blue-marker',
        iconSize: [14, 14],
        iconAnchor: [7, 7]
    });

    // Create marker with custom icon
    const marker = L.marker([lat, lng], {
        icon: blueIcon
    }).addTo(map);

    // Or use circleMarker if you prefer the circle style
    /*
    const marker = L.circleMarker([lat, lng], {
        radius: 7,
        fillColor: "blue",
        color: "white",
        weight: 2,
        fillOpacity: 1
    }).addTo(map);
    */

    // Create popup content
    const popupContent = `
        <div style="padding: 10px;">
            <b>${escapeHtml(name)}</b><br>
            <hr style="margin: 5px 0;">
            Employees: ${escapeHtml(employees.toString())}<br>
            Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}
        </div>
    `;

    marker.bindPopup(popupContent);
    
    // Add to bounds for auto-zoom
    bounds.extend([lat, lng]);
    
    // Optional: Add click event
    marker.on('click', function() {
        console.log(`Clicked: ${name} with ${employees} employees`);
    });
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</body>
</html>
